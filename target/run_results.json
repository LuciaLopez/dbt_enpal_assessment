{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.0b4", "generated_at": "2024-11-24T09:26:14.783415Z", "invocation_id": "3796bbb2-1466-4603-bd54-38aab1f4131a", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:13.700298Z", "completed_at": "2024-11-24T09:26:13.707908Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:13.708731Z", "completed_at": "2024-11-24T09:26:13.831795Z"}], "thread_id": "Thread-1", "execution_time": 0.13465309143066406, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.enpal_assessment_project.calendar_", "compiled": true, "compiled_code": "WITH generate_series AS (\r\nSELECT \r\n   DATE(GENERATE_SERIES(DATE('2023-01-01'), DATE('2030-12-31'), '1 day')) AS day\r\n)\r\nSELECT \r\n   day\r\n  ,DATE(DATE_TRUNC('month', day)) AS month\r\nFROM generate_series", "relation_name": "\"postgres\".\"public\".\"calendar_\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:13.840959Z", "completed_at": "2024-11-24T09:26:13.885782Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:13.886834Z", "completed_at": "2024-11-24T09:26:13.973101Z"}], "thread_id": "Thread-1", "execution_time": 0.13389325141906738, "adapter_response": {"_message": "SELECT 4", "code": "SELECT", "rows_affected": 4}, "message": "SELECT 4", "failures": null, "unique_id": "model.enpal_assessment_project.stg_activity_types", "compiled": true, "compiled_code": "SELECT\n   id\n  ,name\n  ,CASE WHEN active = 'Yes' THEN TRUE ELSE FALSE END AS active\n  ,type\nFROM \"postgres\".\"public\".\"activity_types\"", "relation_name": "\"postgres\".\"public_staging\".\"stg_activity_types\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:13.979768Z", "completed_at": "2024-11-24T09:26:13.992202Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:13.992708Z", "completed_at": "2024-11-24T09:26:14.133725Z"}], "thread_id": "Thread-1", "execution_time": 0.15600943565368652, "adapter_response": {"_message": "INSERT 0 0", "code": "INSERT", "rows_affected": 0}, "message": "INSERT 0 0", "failures": null, "unique_id": "model.enpal_assessment_project.stg_deal_changes", "compiled": true, "compiled_code": "SELECT\n   deal_id\n  ,change_time\n  ,changed_field_key\n  ,new_value\nFROM \"postgres\".\"public\".\"deal_changes\"\n\n\n  WHERE change_time > (SELECT MAX(change_time) FROM \"postgres\".\"public_staging\".\"stg_deal_changes\")\n", "relation_name": "\"postgres\".\"public_staging\".\"stg_deal_changes\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:14.140842Z", "completed_at": "2024-11-24T09:26:14.144713Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:14.146010Z", "completed_at": "2024-11-24T09:26:14.212942Z"}], "thread_id": "Thread-1", "execution_time": 0.07412576675415039, "adapter_response": {"_message": "SELECT 9", "code": "SELECT", "rows_affected": 9}, "message": "SELECT 9", "failures": null, "unique_id": "model.enpal_assessment_project.stg_stages", "compiled": true, "compiled_code": "SELECT *\nFROM \"postgres\".\"public\".\"stages\"", "relation_name": "\"postgres\".\"public_staging\".\"stg_stages\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:14.217792Z", "completed_at": "2024-11-24T09:26:14.222961Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:14.223551Z", "completed_at": "2024-11-24T09:26:14.275124Z"}], "thread_id": "Thread-1", "execution_time": 0.058393001556396484, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.enpal_assessment_project.t_activities", "compiled": true, "compiled_code": "SELECT \n   a.activity_id\n  ,ty.name AS activity_name\n  ,a.assigned_to_user \n  ,a.deal_id \n  ,a.done AS is_done\n  ,a.due_to\n--  ,ty.active \nFROM \"postgres\".\"public_staging\".\"sn_activities\" a\n  LEFT JOIN \"postgres\".\"public_staging\".\"stg_activity_types\" ty ON a.type = ty.type", "relation_name": "\"postgres\".\"public_crm\".\"t_activities\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:14.280976Z", "completed_at": "2024-11-24T09:26:14.284418Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:14.284418Z", "completed_at": "2024-11-24T09:26:14.366784Z"}], "thread_id": "Thread-1", "execution_time": 0.08617568016052246, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.enpal_assessment_project.t_user_deal_events", "compiled": true, "compiled_code": "SELECT\n   deal_id\n  ,change_time\n  ,new_value AS user_id\nFROM \"postgres\".\"public_staging\".\"stg_deal_changes\" dc\nWHERE changed_field_key = 'user_id'", "relation_name": "\"postgres\".\"public_crm\".\"t_user_deal_events\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:14.373759Z", "completed_at": "2024-11-24T09:26:14.378514Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:14.379032Z", "completed_at": "2024-11-24T09:26:14.436305Z"}], "thread_id": "Thread-1", "execution_time": 0.06458830833435059, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.enpal_assessment_project.t_deal_funnel_events", "compiled": true, "compiled_code": "WITH deals AS (\n    -- loading data to use\nSELECT *\nFROM \"postgres\".\"public_staging\".\"stg_deal_changes\"\n)\n\n, deal_creation AS (\n    -- date of the deal creation\nSELECT\n   deal_id\n  ,change_time\n  ,changed_field_key\n  ,TO_TIMESTAMP(REPLACE(new_value, 'T', ' '), 'YYYY-MM-DD HH24:MI:SS') AS new_value\nFROM deals d\nWHERE changed_field_key = 'add_time'\n)\n\n, activities_substeps AS (\n    -- getting the Sales calls from the activities table\n    -- should only 'is_done' be considered...?\nSELECT\n   deal_id\n  ,due_to AS change_time\n  ,CASE\n     WHEN activity_name = 'Sales Call 1' THEN 2.1\n   \t WHEN activity_name = 'Sales Call 2' THEN 3.1\n   END stage_id\n  ,activity_name AS stage_name\nFROM \"postgres\".\"public_crm\".\"t_activities\"\nWHERE activity_name IN ('Sales Call 1', 'Sales Call 2')\n--  AND is_done IS TRUE\n)\n\n, stage_events AS (\nSELECT\n   d.deal_id \n  ,d.change_time\n  ,d.new_value::FLOAT AS stage_id\n  ,s.stage_name\nFROM deals d\n LEFT JOIN \"postgres\".\"public_staging\".\"stg_stages\" s ON d.new_value::NUMERIC = s.stage_id::NUMERIC\nWHERE changed_field_key = 'stage_id'\n)\n\nSELECT\n   deal_id\n  ,new_value AS change_time -- adding the official deal creation date, although they seem to be always the same\n  ,0.0 AS stage_id\n  ,'Deal creation' AS stage_name\nFROM deal_creation \nUNION ALL\nSELECT \n   deal_id\n  ,change_time\n  ,stage_id\n  ,stage_name\nFROM stage_events\nUNION ALL\n-- adding only activities that exist in deal_changes\nSELECT\n   deal_id\n  ,change_time\n  ,stage_id::FLOAT\n  ,stage_name\nFROM activities_substeps\nWHERE deal_id IN (SELECT DISTINCT deal_id FROM stage_events)", "relation_name": "\"postgres\".\"public_crm\".\"t_deal_funnel_events\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:14.442709Z", "completed_at": "2024-11-24T09:26:14.447987Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:14.447987Z", "completed_at": "2024-11-24T09:26:14.542798Z"}], "thread_id": "Thread-1", "execution_time": 0.10593223571777344, "adapter_response": {"_message": "CREATE VIEW", "code": "CREATE VIEW", "rows_affected": -1}, "message": "CREATE VIEW", "failures": null, "unique_id": "model.enpal_assessment_project.t_sales_funnel_monthly_rows", "compiled": true, "compiled_code": "WITH calendar_ AS (\n-- creating a time dimension\nSELECT DISTINCT\n   month\nFROM \"postgres\".\"public\".\"calendar_\" --public.calendar_\nWHERE month BETWEEN '2024-01-01' AND DATE_TRUNC('month', current_date)\n)\n, funnel_steps AS (\n-- getting the current funnel steps\nSELECT DISTINCT stage_id, stage_name \nFROM \"postgres\".\"public_crm\".\"t_deal_funnel_events\" \n)\n, funnel_events AS (\n-- all the funnel events\nSELECT DISTINCT\n   deal_id\n  ,change_time AS event_time\n  ,LEAD(change_time) OVER (PARTITION BY deal_id ORDER BY change_time) AS next_event_time\n  ,DATE_TRUNC('month', DATE(change_time)) AS event_month\n  ,stage_id \n  ,stage_name\nFROM \"postgres\".\"public_crm\".\"t_deal_funnel_events\"\n)\n, cross_join_days_steps AS (\n-- building the catalog of month and funnel step\nSELECT *\nFROM calendar_\nCROSS JOIN funnel_steps\n)\n, kpi_deal_count AS (\nSELECT\n   event_month\n  ,stage_id\n  ,stage_name\n  ,COUNT(DISTINCT deal_id) deals_count\nFROM funnel_events \nGROUP BY\n  event_month\n ,stage_id\n ,stage_name\n)\n, kpi_avg_users AS (\nSELECT\n   stage_id\n  ,event_month\n  ,AVG(users_count) AS avg_users_per_deal\nFROM (\n    SELECT\n       fe.deal_id,\n       fe.stage_id,\n       fe.event_month,\n       COUNT(DISTINCT ud.user_id) AS users_count\n    FROM funnel_events fe\n    LEFT JOIN \"postgres\".\"public_crm\".\"t_user_deal_events\" ud\n      ON ud.deal_id = fe.deal_id  AND ud.change_time BETWEEN fe.event_time AND fe.next_event_time\n    GROUP BY \n       fe.deal_id\n      ,fe.stage_id\n      ,fe.event_month\n) users_per_deal\nGROUP BY \n   stage_id\n  ,event_month\n)\n, draft_funnel AS (\nSELECT DISTINCT\n   s.month \n  ,s.stage_id\n  ,s.stage_name \n  ,dc.deals_count::FLOAT AS deals_count\n  ,COALESCE(au.avg_users_per_deal, 0) AS avg_users_per_deal\nFROM cross_join_days_steps s\nLEFT JOIN funnel_events fe ON s.month = fe.event_month  AND s.stage_id = fe.stage_id\nLEFT JOIN kpi_deal_count dc ON s.month = dc.event_month AND s.stage_name = dc.stage_name\nLEFT JOIN kpi_avg_users au ON s.month = au.event_month AND s.stage_id = au.stage_id\n)\n, funnel_with_conversion_rate AS (\n-- calculating conversion rate but not taking into consideration steps 2.1 and 3.1 (they are optional?)\nSELECT\n   month \n  ,stage_id\n  ,stage_name\n  ,deals_count\n  ,prev_deals_count\n  ,avg_users_per_deal\n  ,CASE\n     WHEN stage_id NOT IN (2.1, 3.1) \n       THEN deals_count / NULLIF(prev_deals_count,0) * 100 \n   END AS conversion_rate\nFROM (\n\tSELECT *, \n\t  LAG(CASE WHEN stage_id NOT IN (2.1, 3.1) THEN deals_count ELSE NULL END)  \n\t    OVER (PARTITION BY month /* IGNORE NULLS */ \n\t    -- ordering the stages to get the previous steps ignoring 2.1 and 3.1\n\t            ORDER BY\n\t              CASE WHEN stage_id IN (2.1, 3.1) THEN NULL ELSE stage_id END \n\t  ) prev_deals_count\n\tFROM draft_funnel\n)\n)\nSELECT\n   month,\n   stage_id,\n   stage_name,\n   'deals_count' AS funnel_kpi,\n   deals_count AS kpi_value\nFROM funnel_with_conversion_rate\nUNION ALL\nSELECT\n   month,\n   stage_id,\n   stage_name,\n   'avg_users_per_deal' AS funnel_kpi,\n   avg_users_per_deal AS kpi_value\nFROM funnel_with_conversion_rate\nUNION ALL\nSELECT\n   month,\n   stage_id,\n   stage_name,\n   'conversion_rate' AS funnel_kpi,\n   conversion_rate AS kpi_value\nFROM funnel_with_conversion_rate\nORDER BY month, stage_id, funnel_kpi", "relation_name": "\"postgres\".\"public_crm\".\"t_sales_funnel_monthly_rows\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-24T09:26:14.550547Z", "completed_at": "2024-11-24T09:26:14.575237Z"}, {"name": "execute", "started_at": "2024-11-24T09:26:14.577621Z", "completed_at": "2024-11-24T09:26:14.753811Z"}], "thread_id": "Thread-1", "execution_time": 0.20408225059509277, "adapter_response": {"_message": "SELECT 396", "code": "SELECT", "rows_affected": 396}, "message": "SELECT 396", "failures": null, "unique_id": "model.enpal_assessment_project.rep_sales_funnel_monthly", "compiled": true, "compiled_code": "SELECT\n   TO_CHAR(month, 'YYYY-MM') AS month\n  ,stage_id AS funnel_step_id\n  ,stage_name AS funnel_step\n  ,funnel_kpi\n  ,COALESCE(CASE WHEN funnel_kpi IN ('avg_users_per_deal','conversion_rate')\n     THEN ROUND(kpi_value::numeric, 2)\n     ELSE kpi_value\n   END,0) AS kpi_value\nFROM \"postgres\".\"public_crm\".\"t_sales_funnel_monthly_rows\"\n-- ORDER BY \n--    month \n--   ,stage_id\n--   ,funnel_kpi", "relation_name": "\"postgres\".\"public_marts_crm\".\"rep_sales_funnel_monthly\"", "batch_results": null}], "elapsed_time": 1.4877476692199707, "args": {"print": true, "static_parser": true, "warn_error_options": {"include": [], "exclude": []}, "introspect": true, "log_file_max_bytes": 10485760, "log_level_file": "debug", "partial_parse_file_diff": true, "log_path": "C:\\Users\\Lucia\\Documents\\Git\\dbt_enpal_assessment\\logs", "project_dir": "C:\\Users\\Lucia\\Documents\\Git\\dbt_enpal_assessment", "quiet": false, "skip_nodes_if_on_run_start_fails": false, "select": ["+rep_sales_funnel_monthly"], "use_colors_file": true, "vars": {}, "version_check": true, "log_format": "default", "empty": false, "macro_debugging": false, "require_nested_cumulative_type_params": false, "strict_mode": false, "printer_width": 80, "state_modified_compare_more_unrendered_values": false, "populate_cache": true, "profiles_dir": "C:\\Users\\Lucia\\Documents\\Git\\dbt_enpal_assessment", "send_anonymous_usage_stats": true, "favor_state": false, "indirect_selection": "eager", "require_explicit_package_overrides_for_builtin_materializations": true, "use_colors": true, "require_resource_names_without_spaces": false, "defer": false, "invocation_command": "dbt run -s +rep_sales_funnel_monthly", "log_level": "info", "source_freshness_run_project_hooks": false, "state_modified_compare_vars": false, "which": "run", "write_json": true, "log_format_file": "debug", "partial_parse": true, "require_yaml_configuration_for_mf_time_spines": false, "show_resource_report": false, "cache_selected_only": false, "exclude": []}}